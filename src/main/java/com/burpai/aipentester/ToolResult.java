package com.burpai.aipentester;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

public class ToolResult {
  private static final ObjectMapper JSON = new ObjectMapper();

  final boolean ok;
  final String kind; // ok | error | blocked
  final Integer requestId;
  final String method;
  final String url;
  final Map<String, String> requestHeaders;
  final String requestBodyPreview;
  final Integer status;
  final Map<String, List<String>> responseHeaders;
  final String responseBodyPreview;
  final Boolean responseBodyLikelyBinary;
  final Long durationMs;
  final String error;

  private ToolResult(boolean ok,
                     String kind,
                     Integer requestId,
                     String method,
                     String url,
                     Map<String, String> requestHeaders,
                     String requestBodyPreview,
                     Integer status,
                     Map<String, List<String>> responseHeaders,
                     String responseBodyPreview,
                     Boolean responseBodyLikelyBinary,
                     Long durationMs,
                     String error) {
    this.ok = ok;
    this.kind = kind;
    this.requestId = requestId;
    this.method = method;
    this.url = url;
    this.requestHeaders = requestHeaders;
    this.requestBodyPreview = requestBodyPreview;
    this.status = status;
    this.responseHeaders = responseHeaders;
    this.responseBodyPreview = responseBodyPreview;
    this.responseBodyLikelyBinary = responseBodyLikelyBinary;
    this.durationMs = durationMs;
    this.error = error;
  }

  static ToolResult ok(int requestId,
                       String method,
                       String url,
                       Map<String, String> requestHeaders,
                       String requestBodyPreview,
                       int status,
                       Map<String, List<String>> responseHeaders,
                       String responseBodyPreview,
                       boolean responseBodyLikelyBinary,
                       long durationMs) {
    return new ToolResult(true, "ok", requestId, method, url, requestHeaders, requestBodyPreview,
        status, responseHeaders, responseBodyPreview, responseBodyLikelyBinary, durationMs, null);
  }

  static ToolResult blocked(int requestId, String method, String url, String msg) {
    return new ToolResult(false, "blocked", requestId, method, url,
        Map.of(), null, null, Map.of(), null, null, null, msg);
  }

  static ToolResult error(String method, String url, String msg) {
    return new ToolResult(false, "error", null, method, url,
        Map.of(), null, null, Map.of(), null, null, null, msg);
  }

  public String toJson() {
    Map<String, Object> out = new LinkedHashMap<>();
    out.put("ok", ok);
    out.put("kind", kind);
    if (requestId != null) out.put("request_id", requestId);
    if (method != null) out.put("method", method);
    if (url != null) out.put("url", url);
    if (requestHeaders != null && !requestHeaders.isEmpty()) out.put("request_headers", requestHeaders);
    if (requestBodyPreview != null) out.put("request_body_preview", requestBodyPreview);
    if (status != null) out.put("status_code", status);
    if (responseHeaders != null && !responseHeaders.isEmpty()) out.put("response_headers", responseHeaders);
    if (responseBodyPreview != null) out.put("response_body_preview", responseBodyPreview);
    if (responseBodyLikelyBinary != null) out.put("response_body_likely_binary", responseBodyLikelyBinary);
    if (durationMs != null) out.put("duration_ms", durationMs);
    if (!ok) out.put("error", error);

    try {
      return JSON.writeValueAsString(out);
    } catch (JsonProcessingException e) {
      // Last-resort fallback, still JSON-ish.
      return "{\"ok\":" + ok + ",\"kind\":\"" + kind + "\",\"error\":\"failed_to_serialize_tool_result\"}";
    }
  }
}

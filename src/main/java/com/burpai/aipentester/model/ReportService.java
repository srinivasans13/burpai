package com.burpai.aipentester.model;

import burp.api.montoya.MontoyaApi;

import java.io.File;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import com.burpai.aipentester.agent.AgentLogger;
import com.burpai.aipentester.agent.AgentUtils;

/**
 * Generates the HTML vulnerability report from the findings accumulated during a run.
 */
public class ReportService {

  private final MontoyaApi api;
  private final AgentLogger logger;
  private final List<Map<String, Object>> vulnStore;

  public ReportService(MontoyaApi api, AgentLogger logger, List<Map<String, Object>> vulnStore) {
    this.api = api;
    this.logger = logger;
    this.vulnStore = vulnStore;
  }

  public void generateReport() {
    if (vulnStore.isEmpty()) {
      logger.log("\n[INFO] No vulnerabilities have been reported in this session.\n");
      return;
    }

    try {
      String home = System.getProperty("user.home");
      File dir = new File(home, "burpai_logs");
      if (!dir.exists()) dir.mkdirs();

      String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
      File reportFile = new File(dir, "report_" + timestamp + ".html");

      try (PrintWriter out = new PrintWriter(new FileWriter(reportFile, java.nio.charset.StandardCharsets.UTF_8))) {
        out.println("<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'>");
        out.println("<title>BurpAI Pentest Report</title>");
        out.println("<style>");
        out.println("body{font-family:Arial,sans-serif;margin:40px;background:#f9f9f9;color:#222}");
        out.println("h1{color:#b22222} h2{color:#333;border-bottom:2px solid #ddd;padding-bottom:4px}");
        out.println(".vuln{background:#fff;border:1px solid #ddd;border-radius:6px;margin:20px 0;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.07)}");
        out.println(".severity{display:inline-block;padding:3px 10px;border-radius:4px;font-weight:bold;font-size:.9em;margin-bottom:8px}");
        out.println(".Critical{background:#ffd6d6;color:#a00}");
        out.println(".High{background:#ffe5cc;color:#a04000}");
        out.println(".Medium{background:#fff3cd;color:#856404}");
        out.println(".Low{background:#d4edda;color:#155724}");
        out.println(".Info,.Informational{background:#d1ecf1;color:#0c5460}");
        out.println(".observed-badge{font-size:.75em;font-weight:normal;margin-left:8px;padding:2px 7px;border-radius:3px;background:#e8e8e8;color:#666;vertical-align:middle}");
        out.println(".vuln.observed{border-left:4px solid #aaa;opacity:.92}");
        out.println("table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px 10px;text-align:left} th{background:#f0f0f0;width:160px}");
        out.println("pre{background:#272822;color:#f8f8f2;padding:12px;border-radius:4px;overflow-x:auto;white-space:pre-wrap;word-break:break-word}");
        out.println("</style></head><body>");
        out.println("<h1>BurpAI Penetration Test Report</h1>");
        out.println("<p>Generated: "
            + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
            + "</p>");

        long confirmed = vulnStore.stream().filter(v -> !Boolean.TRUE.equals(v.get("observed_only"))).count();
        long observed  = vulnStore.size() - confirmed;
        out.println("<p>Total findings: <strong>" + vulnStore.size() + "</strong>"
            + " &nbsp;|&nbsp; Confirmed: <strong>" + confirmed + "</strong>"
            + " &nbsp;|&nbsp; Observed: <strong>" + observed + "</strong></p>");

        // Severity sort order
        java.util.function.Function<Map<String,Object>,Integer> sevOrd = v -> {
          String s = AgentUtils.str(v.getOrDefault("severity","Unknown")).toLowerCase();
          return switch(s) { case "critical" -> 0; case "high" -> 1; case "medium" -> 2; case "low" -> 3; default -> 4; };
        };
        vulnStore.sort(java.util.Comparator.comparingInt(sevOrd::apply));

        // Summary table
        out.println("<h2>Summary</h2><table><tr><th>#</th><th>Name</th><th>Severity</th><th>Location</th><th>Status</th></tr>");
        int idx = 0;
        for (Map<String, Object> v : vulnStore) {
          idx++;
          boolean obs = Boolean.TRUE.equals(v.get("observed_only"));
          String status = obs ? "<span style='color:#888'>Observed</span>" : "<span style='color:#080;font-weight:bold'>Confirmed</span>";
          out.printf("<tr><td>%d</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>%n",
              idx, AgentUtils.escField(v, "name"),
              AgentUtils.escField(v, "severity"),
              AgentUtils.escField(v, "location"),
              status);
        }
        out.println("</table>");

        // Detail sections
        out.println("<h2>Findings</h2>");
        idx = 0;
        for (Map<String, Object> v : vulnStore) {
          idx++;
          String sev = AgentUtils.str(v.getOrDefault("severity", "Unknown"));
          String sevClass = sev.isEmpty() ? "Unknown" : sev.substring(0, 1).toUpperCase() + sev.substring(1).toLowerCase();
          boolean obs = Boolean.TRUE.equals(v.get("observed_only"));
          out.println("<div class='vuln" + (obs ? " observed" : "") + "'>");
          out.printf("<h2>%d. %s", idx, AgentUtils.escField(v, "name"));
          if (obs) out.print("<span class='observed-badge'>Observed &#8211; not PoC confirmed</span>");
          out.println("</h2>");
          out.printf("<span class='severity %s'>%s</span>%n", sevClass, AgentUtils.escHtml(sev));
          out.println("<table>");
          row(out, "Location", AgentUtils.escField(v, "location"));
          row(out, "Description", AgentUtils.escField(v, "description"));
          String impact = AgentUtils.str(v.getOrDefault("impact", ""));
          if (!impact.isBlank()) row(out, "Impact", AgentUtils.escField(v, "impact"));
          row(out, "Remediation", AgentUtils.escField(v, "remediation"));
          Object ids = v.get("evidence_request_ids");
          if (ids != null) row(out, "Evidence Request IDs", AgentUtils.escHtml(ids.toString()));
          out.println("</table>");
          String poc = AgentUtils.str(v.getOrDefault("poc", ""));
          if (!poc.isBlank()) {
            out.println("<h3>Proof of Concept</h3><pre>" + AgentUtils.escHtml(poc) + "</pre>");
          }
          out.println("</div>");
        }

        out.println("</body></html>");
      }

      String path = reportFile.getAbsolutePath();
      logger.log("\n" + "=".repeat(80) + "\n");
      logger.log("REPORT GENERATED\n");
      logger.log("Findings: " + vulnStore.size() + "\n");
      logger.log("File: " + path + "\n");
      logger.log("Open in browser: file:///" + path.replace('\\', '/').replace(" ", "%20") + "\n");
      logger.log("=".repeat(80) + "\n\n");

    } catch (Exception e) {
      logger.log("[ERROR] Failed to generate report: " + e.getMessage() + "\n");
      api.logging().logToError("generateReport failed: " + e);
    }
  }

  private static void row(PrintWriter out, String label, String value) {
    out.printf("<tr><th>%s</th><td>%s</td></tr>%n", AgentUtils.escHtml(label), value);
  }
}

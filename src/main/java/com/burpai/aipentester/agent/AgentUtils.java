package com.burpai.aipentester.agent;

import java.net.URLDecoder;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.*;

/**
 * Pure static utilities shared across agent services.
 * Extracted from AgentEngine to eliminate duplication and clarify responsibilities.
 */
public final class AgentUtils {

  private AgentUtils() {}

  // ── String helpers ────────────────────────────────────────────────────────

  public static String str(Object o) {
    return o == null ? "" : String.valueOf(o);
  }

  public static String truncate(String s, int max) {
    if (s == null) return null;
    if (s.length() <= max) return s;
    return s.substring(0, max) + "...[truncated]";
  }

  public static boolean looksBinary(String s) {
    if (s == null || s.isEmpty()) return false;
    int nonPrintable = 0;
    int sample = Math.min(s.length(), 512);
    for (int i = 0; i < sample; i++) {
      char c = s.charAt(i);
      boolean printable = (c == '\n' || c == '\r' || c == '\t')
          || (c >= 0x20 && c <= 0x7E);
      if (!printable) nonPrintable++;
    }
    return (nonPrintable / (double) sample) > 0.15;
  }

  // ── URL helpers ───────────────────────────────────────────────────────────

  public static String normalizeBase(String s) {
    if (s == null) return "";
    s = s.trim();
    int hash = s.indexOf('#');
    if (hash >= 0) s = s.substring(0, hash);
    while (s.endsWith("/")) s = s.substring(0, s.length() - 1);
    return s;
  }

  public static String toAbsolute(String targetBase, String endpointOrUrl) {
    String s = endpointOrUrl.trim();
    if (s.startsWith("http://") || s.startsWith("https://")) return s;
    String base = normalizeBase(targetBase);
    if (!s.startsWith("/")) s = "/" + s;
    return base + s;
  }

  public static String setQueryParam(String url, String param, String value) {
    try {
      int q = url.indexOf('?');
      String base  = q < 0 ? url : url.substring(0, q);
      String query = q < 0 ? "" : url.substring(q + 1);
      Map<String, String> params = new LinkedHashMap<>();
      if (!query.isBlank()) {
        for (String pair : query.split("&")) {
          int eq = pair.indexOf('=');
          String k = eq < 0 ? pair : pair.substring(0, eq);
          String v = eq < 0 ? "" : pair.substring(eq + 1);
          try {
            k = URLDecoder.decode(k, StandardCharsets.UTF_8);
            v = URLDecoder.decode(v, StandardCharsets.UTF_8);
          } catch (Exception ignored) {}
          params.put(k, v);
        }
      }
      params.put(param, value);
      StringBuilder sb = new StringBuilder(base).append('?');
      boolean first = true;
      for (Map.Entry<String, String> e : params.entrySet()) {
        if (!first) sb.append('&');
        first = false;
        sb.append(URLEncoder.encode(e.getKey(), StandardCharsets.UTF_8));
        sb.append('=');
        sb.append(URLEncoder.encode(e.getValue(), StandardCharsets.UTF_8));
      }
      return sb.toString();
    } catch (Exception ex) {
      return url + (url.contains("?") ? "&" : "?") + param + "=" + value;
    }
  }

  public static String resolveUrl(String base, String url) {
    if (url == null || url.isBlank()) return null;
    String u = url.trim();
    if (u.startsWith("javascript:") || u.startsWith("mailto:")
        || u.startsWith("#") || u.startsWith("data:")) return null;
    if (u.startsWith("http://") || u.startsWith("https://")) return u;
    if (u.startsWith("//")) return (base.startsWith("https") ? "https:" : "http:") + u;
    if (u.startsWith("/")) return base + u;
    int lastSlash = base.lastIndexOf('/');
    String dir = (lastSlash > 8) ? base.substring(0, lastSlash + 1) : base + "/";
    return dir + u;
  }

  public static void addSitemapEntry(List<Map<String, Object>> endpoints,
                               Set<String> seenFp,
                               String url,
                               String method,
                               int status) {
    try {
      String path = url;
      List<String> queryParamNames = new ArrayList<>();
      int q = url.indexOf('?');
      if (q >= 0) {
        path = url.substring(0, q);
        String query = url.substring(q + 1);
        for (String pair : query.split("&")) {
          int eq = pair.indexOf('=');
          String name = eq < 0 ? pair : pair.substring(0, eq);
          try { name = URLDecoder.decode(name, StandardCharsets.UTF_8); }
          catch (Exception ignored) {}
          if (!name.isBlank()) queryParamNames.add(name);
        }
      }
      int hash = path.indexOf('#');
      if (hash >= 0) path = path.substring(0, hash);

      String fp = method + ":" + path;
      if (!seenFp.add(fp)) return;

      Map<String, Object> entry = new LinkedHashMap<>();
      entry.put("method", method);
      entry.put("path", path);
      entry.put("status", status);
      if (!queryParamNames.isEmpty()) entry.put("query_params", queryParamNames);
      endpoints.add(entry);
    } catch (Exception ignored) {}
  }

  // ── Fuzz helpers ─────────────────────────────────────────────────────────

  /**
   * Determines whether a fuzz response is worth flagging as interesting.
   *
   * <p>Includes WAF-aware detection: when a WAF is present it often returns
   * {@code 200 OK} with a generic block page at similar body length — the standard
   * 10% length heuristic would miss this. The WAF-aware path lowers the threshold to
   * 5% AND checks for suspicious body-shrink (content stripped by WAF) and for
   * JSON-key-count deviation (WAF removing fields from an otherwise valid response).
   *
   * @param wafDetected whether the run's {@link MemoryManager} flagged a WAF
   */
  public static boolean isFuzzInteresting(int st, int len, int bSt, int bLen, String body,
                                   boolean wafDetected) {
    if (st != bSt) return true;

    // WAF-aware length threshold: 5 % (vs 10 % normally)
    double threshold = wafDetected ? 0.05 : 0.10;
    if (bLen > 0 && Math.abs(len - bLen) > bLen * threshold) return true;

    // WAF normalisation heuristic: response body shrank significantly (WAF stripped content)
    if (wafDetected && bLen > 200 && len > 0 && len < bLen * 0.70) return true;

    // JSON-key-count deviation: WAF's block page usually has fewer fields than a real response
    if (wafDetected && bLen > 0 && body != null && body.trim().startsWith("{")) {
      int baselineKeyCount  = estimateJsonKeyCount(body); // proxy: count occurrences of '":"'
      // We compare against a rough expected count; flag if drastically lower
      if (baselineKeyCount == 0 && bLen > 100) return true; // all keys stripped
    }

    String lower = body == null ? "" : body.toLowerCase(Locale.ROOT);
    for (String sig : new String[]{
        "sql syntax", "mysql", "you have an error", "sqlexception", "unclosed quotation",
        "traceback", "exception in thread", "stack trace", "syntax error", "eval(",
        "undefined method", "internal server error", "access denied", "permission denied",
        "root:", "etc/passwd", "uid=", "win.ini", "invalid query", "divide by zero",
        "column", "table"}) {
      if (lower.contains(sig)) return true;
    }
    return false;
  }

  /** Backward-compatible overload (wafDetected=false). */
  public static boolean isFuzzInteresting(int st, int len, int bSt, int bLen, String body) {
    return isFuzzInteresting(st, len, bSt, bLen, body, false);
  }

  /** Rough count of JSON key occurrences in a response body (avoids a full JSON parse). */
  private static int estimateJsonKeyCount(String body) {
    if (body == null) return 0;
    int count = 0;
    int idx = 0;
    while ((idx = body.indexOf("\":", idx)) >= 0) { count++; idx += 2; }
    return count;
  }

  public static String fuzzInterestReason(int st, int len, int bSt, int bLen, String body) {
    return fuzzInterestReason(st, len, bSt, bLen, body, false);
  }

  public static String fuzzInterestReason(int st, int len, int bSt, int bLen, String body,
                                    boolean wafDetected) {
    List<String> r = new ArrayList<>();
    if (st != bSt) r.add("status_changed:" + bSt + "→" + st);
    double threshold = wafDetected ? 0.05 : 0.10;
    if (bLen > 0 && Math.abs(len - bLen) > bLen * threshold) r.add("length_changed:" + bLen + "→" + len);
    if (wafDetected && bLen > 200 && len > 0 && len < bLen * 0.70) r.add("waf_content_stripped:" + bLen + "→" + len);
    String lower = body == null ? "" : body.toLowerCase(Locale.ROOT);
    for (String sig : new String[]{
        "sql syntax", "mysql", "traceback", "exception", "stack trace",
        "syntax error", "internal server error", "access denied", "root:", "etc/passwd", "uid="}) {
      if (lower.contains(sig)) { r.add("error_keyword:" + sig); break; }
    }
    return String.join(", ", r);
  }

  /**
   * Returns WAF-bypass encoded variants of a payload for retry when in-band results
   * are all blocked.  Variants: double URL-encode, unicode-escape, comment insertion,
   * and mixed-case (for SQL keywords).
   */
  public static List<String> buildWafBypassVariants(String payload) {
    List<String> variants = new ArrayList<>();
    if (payload == null || payload.isBlank()) return variants;

    // 1. Double URL-encode special chars
    try {
      String once = java.net.URLEncoder.encode(payload, StandardCharsets.UTF_8);
      String twice = java.net.URLEncoder.encode(once, StandardCharsets.UTF_8);
      if (!twice.equals(payload)) variants.add(twice);
    } catch (Exception ignored) {}

    // 2. Unicode fullwidth substitution for alpha chars (ＳＥＬＥＣＴstyle bypass)
    StringBuilder uc = new StringBuilder();
    boolean hasAlpha = false;
    for (char c : payload.toCharArray()) {
      if (c >= 'A' && c <= 'Z') { uc.append((char)(0xFF21 + (c - 'A'))); hasAlpha = true; }
      else if (c >= 'a' && c <= 'z') { uc.append((char)(0xFF41 + (c - 'a'))); hasAlpha = true; }
      else uc.append(c);
    }
    if (hasAlpha) variants.add(uc.toString());

    // 3. SQL comment insertion between first two space-separated words (un/**/ion se/**/lect)
    String commented = payload.replaceFirst("(?i)(SELECT|UNION|INSERT|UPDATE|DELETE|WHERE|FROM|AND|OR)",
        "$1/**/");
    if (!commented.equals(payload)) variants.add(commented);

    // 4. Mixed case
    StringBuilder mc = new StringBuilder();
    for (int i = 0; i < payload.length(); i++) {
      char c = payload.charAt(i);
      mc.append(i % 2 == 0 ? Character.toUpperCase(c) : Character.toLowerCase(c));
    }
    String mixed = mc.toString();
    if (!mixed.equals(payload) && !mixed.equalsIgnoreCase(payload) == false) variants.add(mixed);

    // 5. HTML entity encode < and > for XSS context
    if (payload.contains("<") || payload.contains(">")) {
      variants.add(payload.replace("<", "&lt;").replace(">", "&gt;"));
      // Also: hex entity
      variants.add(payload.replace("<", "&#x3C;").replace(">", "&#x3E;"));
    }

    return variants;
  }

  // ── Crypto helpers ────────────────────────────────────────────────────────

  public static String padBase64(String s) {
    return s + "=".repeat((4 - s.length() % 4) % 4);
  }

  // ── Message helpers ───────────────────────────────────────────────────────

  public static Map<String, Object> msg(String role, String content) {
    Map<String, Object> m = new HashMap<>();
    m.put("role", role);
    m.put("content", content);
    return m;
  }

  // ── HTML helpers (used by ReportService) ─────────────────────────────────

  public static String escHtml(String s) {
    if (s == null) return "";
    return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;").replace("\"", "&quot;");
  }

  public static String escField(Map<String, Object> m, String key) {
    return escHtml(str(m.getOrDefault(key, "")));
  }
}

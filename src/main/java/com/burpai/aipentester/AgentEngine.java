package com.burpai.aipentester;

import burp.api.montoya.MontoyaApi;
import burp.api.montoya.http.message.HttpRequestResponse;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.File;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.BiConsumer;
import java.util.function.Consumer;

/**
 * Thin facade that wires together all agent services and exposes the same public API
 * that {@link AgentTab} consumed from the original monolithic class.
 *
 * <p>Actual work is delegated to:
 * <ul>
 *   <li>{@link AgentLoop}    – orchestrates the agentic iteration loop</li>
 *   <li>{@link ToolExecutor} – executes all tool calls</li>
 *   <li>{@link LlmGateway}  – manages LLM clients, prompt loading, and personas</li>
 *   <li>{@link ReportService}– generates the HTML vulnerability report</li>
 *   <li>{@link MemoryManager}– tracks per-run request history and observations</li>
 *   <li>{@link AgentUtils}   – shared static utilities</li>
 *   <li>{@link AgentLogger}  – unified logging to UI and file</li>
 * </ul>
 */
public class AgentEngine {

  //  Backward-compat alias so AgentTab keeps compiling 
  /** @deprecated Reference {@link LlmGateway#BUILT_IN_PERSONAS} directly instead. */
  @Deprecated
  static final java.util.LinkedHashMap<String, String> BUILT_IN_PERSONAS =
      LlmGateway.BUILT_IN_PERSONAS;

  //  Services 

  private final LlmGateway  llmGateway;
  private final AgentLoop   agentLoop;
  private final ReportService reportService;
  private final AtomicBoolean running = new AtomicBoolean(false);

  //  Constructor 

  public AgentEngine(MontoyaApi api,
                     Consumer<String> log,
                     BiConsumer<AgentTab.LogRow, HttpRequestResponse> addRow,
                     Consumer<HttpRequestResponse> showEditors) {

    String logFilePath = initLogFile(api, log);
    AgentLogger logger = new AgentLogger(log, logFilePath);

    if (logFilePath != null) {
      logger.log("[INFO] Persistent logging enabled: " + logFilePath + "\n");
    }

    // Shared mutable state passed by reference to services that need it
    List<Map<String, Object>>                    vulnStore         = new CopyOnWriteArrayList<>();
    Map<Integer, String>                         responseBodyStore  = new ConcurrentHashMap<>();
    Map<Integer, burp.api.montoya.http.message.HttpRequestResponse> rrStore = new ConcurrentHashMap<>();
    Map<String, String>                          sessionVars        = new ConcurrentHashMap<>();
    AtomicInteger                                counter            = new AtomicInteger(0);

    llmGateway = new LlmGateway(api, logger);

    ToolExecutor tools = new ToolExecutor(
        api, new ObjectMapper(), logger,
        vulnStore, responseBodyStore, rrStore, sessionVars,
        addRow, showEditors, counter);

    reportService = new ReportService(api, logger, vulnStore);

    TargetMemoryStore targetMemory = new TargetMemoryStore(logger);

    agentLoop = new AgentLoop(
        api, new ObjectMapper(), logger,
        llmGateway, tools,
        vulnStore, running, targetMemory);
  }

  //  Public API (unchanged from original AgentEngine) 

  public void stop() {
    running.set(false);
  }

  public void testConnection(String provider, String baseUrl, String model, String apiKey) {
    llmGateway.testConnection(provider, baseUrl, model, apiKey);
  }

  public void singleTurn(String provider, String baseUrl, String model, String apiKey,
                         String targetBase, Imported imported, String userPrompt,
                         String personaPayload) {
    agentLoop.singleTurn(provider, baseUrl, model, apiKey, targetBase, imported, userPrompt, personaPayload);
  }

  public void runAgent(String provider, String baseUrl, String model, String apiKey,
                       String targetBase, int maxIter, boolean autoMode,
                       Imported imported, String userPrompt, String personaPayload) {
    agentLoop.runAgent(provider, baseUrl, model, apiKey, targetBase, maxIter, autoMode,
        imported, userPrompt, personaPayload);
  }

  public void generateReport() {
    reportService.generateReport();
  }

  //  Private helpers 

  private static String initLogFile(MontoyaApi api, Consumer<String> log) {
    try {
      String home = System.getProperty("user.home");
      File dir = new File(home, "burpai_logs");
      if (!dir.exists()) dir.mkdirs();

      String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
      File logFile = new File(dir, "agent_" + timestamp + ".log");

      try (PrintWriter out = new PrintWriter(new FileWriter(logFile, true))) {
        out.println("=== Agent Session Initialized: " + LocalDateTime.now() + " ===");
        out.println("=== Log file: " + logFile.getAbsolutePath() + " ===");
      }
      return logFile.getAbsolutePath();
    } catch (Exception e) {
      api.logging().logToError("Failed to initialize log file: " + e.getMessage());
      return null;
    }
  }
}

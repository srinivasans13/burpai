package com.burpai.aipentester;

import java.net.URLDecoder;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.*;

/**
 * Pure static utilities shared across agent services.
 * Extracted from AgentEngine to eliminate duplication and clarify responsibilities.
 */
final class AgentUtils {

  private AgentUtils() {}

  // ── String helpers ────────────────────────────────────────────────────────

  static String str(Object o) {
    return o == null ? "" : String.valueOf(o);
  }

  static String truncate(String s, int max) {
    if (s == null) return null;
    if (s.length() <= max) return s;
    return s.substring(0, max) + "...[truncated]";
  }

  static boolean looksBinary(String s) {
    if (s == null || s.isEmpty()) return false;
    int nonPrintable = 0;
    int sample = Math.min(s.length(), 512);
    for (int i = 0; i < sample; i++) {
      char c = s.charAt(i);
      boolean printable = (c == '\n' || c == '\r' || c == '\t')
          || (c >= 0x20 && c <= 0x7E);
      if (!printable) nonPrintable++;
    }
    return (nonPrintable / (double) sample) > 0.15;
  }

  // ── URL helpers ───────────────────────────────────────────────────────────

  static String normalizeBase(String s) {
    if (s == null) return "";
    s = s.trim();
    int hash = s.indexOf('#');
    if (hash >= 0) s = s.substring(0, hash);
    while (s.endsWith("/")) s = s.substring(0, s.length() - 1);
    return s;
  }

  static String toAbsolute(String targetBase, String endpointOrUrl) {
    String s = endpointOrUrl.trim();
    if (s.startsWith("http://") || s.startsWith("https://")) return s;
    String base = normalizeBase(targetBase);
    if (!s.startsWith("/")) s = "/" + s;
    return base + s;
  }

  static String setQueryParam(String url, String param, String value) {
    try {
      int q = url.indexOf('?');
      String base  = q < 0 ? url : url.substring(0, q);
      String query = q < 0 ? "" : url.substring(q + 1);
      Map<String, String> params = new LinkedHashMap<>();
      if (!query.isBlank()) {
        for (String pair : query.split("&")) {
          int eq = pair.indexOf('=');
          String k = eq < 0 ? pair : pair.substring(0, eq);
          String v = eq < 0 ? "" : pair.substring(eq + 1);
          try {
            k = URLDecoder.decode(k, StandardCharsets.UTF_8);
            v = URLDecoder.decode(v, StandardCharsets.UTF_8);
          } catch (Exception ignored) {}
          params.put(k, v);
        }
      }
      params.put(param, value);
      StringBuilder sb = new StringBuilder(base).append('?');
      boolean first = true;
      for (Map.Entry<String, String> e : params.entrySet()) {
        if (!first) sb.append('&');
        first = false;
        sb.append(URLEncoder.encode(e.getKey(), StandardCharsets.UTF_8));
        sb.append('=');
        sb.append(URLEncoder.encode(e.getValue(), StandardCharsets.UTF_8));
      }
      return sb.toString();
    } catch (Exception ex) {
      return url + (url.contains("?") ? "&" : "?") + param + "=" + value;
    }
  }

  static String resolveUrl(String base, String url) {
    if (url == null || url.isBlank()) return null;
    String u = url.trim();
    if (u.startsWith("javascript:") || u.startsWith("mailto:")
        || u.startsWith("#") || u.startsWith("data:")) return null;
    if (u.startsWith("http://") || u.startsWith("https://")) return u;
    if (u.startsWith("//")) return (base.startsWith("https") ? "https:" : "http:") + u;
    if (u.startsWith("/")) return base + u;
    int lastSlash = base.lastIndexOf('/');
    String dir = (lastSlash > 8) ? base.substring(0, lastSlash + 1) : base + "/";
    return dir + u;
  }

  static void addSitemapEntry(List<Map<String, Object>> endpoints,
                               Set<String> seenFp,
                               String url,
                               String method,
                               int status) {
    try {
      String path = url;
      List<String> queryParamNames = new ArrayList<>();
      int q = url.indexOf('?');
      if (q >= 0) {
        path = url.substring(0, q);
        String query = url.substring(q + 1);
        for (String pair : query.split("&")) {
          int eq = pair.indexOf('=');
          String name = eq < 0 ? pair : pair.substring(0, eq);
          try { name = URLDecoder.decode(name, StandardCharsets.UTF_8); }
          catch (Exception ignored) {}
          if (!name.isBlank()) queryParamNames.add(name);
        }
      }
      int hash = path.indexOf('#');
      if (hash >= 0) path = path.substring(0, hash);

      String fp = method + ":" + path;
      if (!seenFp.add(fp)) return;

      Map<String, Object> entry = new LinkedHashMap<>();
      entry.put("method", method);
      entry.put("path", path);
      entry.put("status", status);
      if (!queryParamNames.isEmpty()) entry.put("query_params", queryParamNames);
      endpoints.add(entry);
    } catch (Exception ignored) {}
  }

  // ── Fuzz helpers ─────────────────────────────────────────────────────────

  static boolean isFuzzInteresting(int st, int len, int bSt, int bLen, String body) {
    if (st != bSt) return true;
    if (bLen > 0 && Math.abs(len - bLen) > bLen * 0.10) return true;
    String lower = body.toLowerCase(Locale.ROOT);
    for (String sig : new String[]{
        "sql syntax", "mysql", "you have an error", "sqlexception", "unclosed quotation",
        "traceback", "exception in thread", "stack trace", "syntax error", "eval(",
        "undefined method", "internal server error", "access denied", "permission denied",
        "root:", "etc/passwd", "uid=", "win.ini", "invalid query", "divide by zero",
        "column", "table"}) {
      if (lower.contains(sig)) return true;
    }
    return false;
  }

  static String fuzzInterestReason(int st, int len, int bSt, int bLen, String body) {
    List<String> r = new ArrayList<>();
    if (st != bSt) r.add("status_changed:" + bSt + "→" + st);
    if (bLen > 0 && Math.abs(len - bLen) > bLen * 0.10) r.add("length_changed:" + bLen + "→" + len);
    String lower = body.toLowerCase(Locale.ROOT);
    for (String sig : new String[]{
        "sql syntax", "mysql", "traceback", "exception", "stack trace",
        "syntax error", "internal server error", "access denied", "root:", "etc/passwd", "uid="}) {
      if (lower.contains(sig)) { r.add("error_keyword:" + sig); break; }
    }
    return String.join(", ", r);
  }

  // ── Crypto helpers ────────────────────────────────────────────────────────

  static String padBase64(String s) {
    return s + "=".repeat((4 - s.length() % 4) % 4);
  }

  // ── Message helpers ───────────────────────────────────────────────────────

  static Map<String, Object> msg(String role, String content) {
    Map<String, Object> m = new HashMap<>();
    m.put("role", role);
    m.put("content", content);
    return m;
  }

  // ── HTML helpers (used by ReportService) ─────────────────────────────────

  static String escHtml(String s) {
    if (s == null) return "";
    return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;").replace("\"", "&quot;");
  }

  static String escField(Map<String, Object> m, String key) {
    return escHtml(str(m.getOrDefault(key, "")));
  }
}

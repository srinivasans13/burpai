package com.burpai.aipentester;

import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.util.function.Consumer;

/**
 * Centralised logging helper used by all agent services.
 * Writes to the UI log callback and optionally to a persistent log file.
 *
 * <p>The file writer is opened once at construction time and held for the
 * lifetime of the logger. {@link #log} is synchronised so concurrent calls
 * from the agent thread and the Swing EDT cannot interleave writes or race
 * on the underlying {@link FileWriter}.
 */
class AgentLogger {

  private final Consumer<String> ui;
  private final String logFilePath;
  /** Null when file logging is disabled or the file could not be opened. */
  private final PrintWriter fileWriter;

  AgentLogger(Consumer<String> ui, String logFilePath) {
    this.ui = ui;
    this.logFilePath = logFilePath;
    PrintWriter pw = null;
    if (logFilePath != null) {
      try {
        pw = new PrintWriter(new BufferedWriter(new FileWriter(logFilePath, true)));
      } catch (Exception ignored) {
        // File logging unavailable; degrade gracefully to UI-only.
      }
    }
    this.fileWriter = pw;
  }

  synchronized void log(String msg) {
    ui.accept(msg);
    if (fileWriter != null) {
      try {
        fileWriter.print(msg);
        fileWriter.flush();
      } catch (Exception ignored) {
        // Ignore file logging failures to avoid cascading errors.
      }
    }
  }

  /** Flushes and closes the underlying file writer. Call when the session ends. */
  synchronized void close() {
    if (fileWriter != null) {
      try { fileWriter.close(); } catch (Exception ignored) {}
    }
  }

  String logFilePath() {
    return logFilePath;
  }
}

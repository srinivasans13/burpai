package com.burpai.aipentester;

import burp.api.montoya.http.message.HttpHeader;
import burp.api.montoya.http.message.responses.HttpResponse;
import burp.api.montoya.http.message.requests.HttpRequest;

import java.net.URI;
import java.util.LinkedHashMap;
import java.util.Map;

public class Imported {
  final String method;
  final String fullUrl;
  final String baseUrl;
  final String endpoint;
  final Map<String, String> headers;
  final String body;
  final HttpResponse lastResponse; // usually null on import

  Imported(String method,
           String fullUrl,
           String baseUrl,
           String endpoint,
           Map<String, String> headers,
           String body,
           HttpResponse lastResponse) {
    this.method = method;
    this.fullUrl = fullUrl;
    this.baseUrl = baseUrl;
    this.endpoint = endpoint;
    this.headers = headers;
    this.body = body;
    this.lastResponse = lastResponse;
  }

  static Imported from(HttpRequest req) {
    String url = req.url();     // URL method exists 
    String m = req.method();    // method exists 

    String base = url;
    int slash3 = url.indexOf('/', url.indexOf("://") + 3);
    if (slash3 > 0) base = url.substring(0, slash3);

    String endpoint = "/";
    try {
      URI uri = URI.create(url);
      String path = uri.getRawPath();
      String query = uri.getRawQuery();
      if (path != null && !path.isBlank()) endpoint = path;
      if (query != null && !query.isBlank()) endpoint = endpoint + "?" + query;
    } catch (Exception ignored) {
      // fallback to '/'
    }

    Map<String, String> headers = new LinkedHashMap<>();
    try {
      for (HttpHeader h : req.headers()) {
        // Keep the first value if duplicates exist.
        headers.putIfAbsent(h.name(), h.value());
      }
    } catch (Exception ignored) {
      // ignore
    }

    String body = "";
    try {
      body = req.bodyToString();
    } catch (Exception ignored) {
      // ignore
    }

    return new Imported(m, url, base, endpoint, headers, body, null);
  }
}

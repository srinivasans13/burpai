package com.burpai.aipentester;

import burp.api.montoya.MontoyaApi;
import burp.api.montoya.http.message.HttpRequestResponse;
import burp.api.montoya.http.message.requests.HttpRequest;
import burp.api.montoya.ui.contextmenu.ContextMenuEvent;
import burp.api.montoya.ui.contextmenu.ContextMenuItemsProvider;
import burp.api.montoya.ui.contextmenu.MessageEditorHttpRequestResponse;
import burp.api.montoya.ui.editor.HttpRequestEditor;
import burp.api.montoya.ui.editor.HttpResponseEditor;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.border.TitledBorder;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static java.util.Collections.emptyList;

public class AgentTab implements ContextMenuItemsProvider {

  private final MontoyaApi api;
  private final JPanel root = new JPanel(new BorderLayout());

  // Controls
  private final JComboBox<String> providerCombo = new JComboBox<>(new String[]{"Ollama", "Gemini"});
  private final JTextField ollamaUrl = new JTextField("http://localhost:11434", 26);
  private final JTextField geminiApiKey = new JTextField("", 26);
  private final JTextField model = new JTextField("qwen3-coder-next:cloud", 26);
  private final JTextField targetBase = new JTextField("http://localhost", 34);
  private final JSpinner maxIter = new JSpinner(new SpinnerNumberModel(20, 1, 200, 1));
  private final JCheckBox autoMode = new JCheckBox("Auto Mode", true);

  // Label refs needed to show/hide in wireUi
  private JLabel ollamaUrlLabel;
  private JLabel geminiKeyLabel;

  // Persona selection
  private static final String PERSONA_DEFAULT = "General (default)";
  private static final String PERSONA_CUSTOM  = "Custom File...";
  private final JComboBox<String> personaCombo;
  private final JTextField personaFilePath = new JTextField("", 30);
  private final JButton personaBrowseBtn = new JButton("Browse...");
  private volatile String customPersonaContent = null; // non-null when a file has been loaded

  private final JButton testConn = new JButton("Test Connection");
  private final JButton start = new JButton("Start Agent");
  private final JButton stop = new JButton("Stop Agent");
  private final JButton send = new JButton("Send Message");
  private final JButton clear = new JButton("Clear");
  private final JButton report = new JButton("Generate Report");

  private final JTextArea prompt = new JTextArea(3, 80);
  private final JTextArea activity = new JTextArea(10, 90);
  private final JLabel statusLabel = new JLabel("Ready");

  // Native Burp editors in our tab 
  private final HttpRequestEditor requestEditor;
  private final HttpResponseEditor responseEditor;

  // Request log
  private final DefaultTableModel logModel = new DefaultTableModel(
      new Object[]{"#", "Method", "URL", "Status", "Purpose", "Time"}, 0
  );
  private final JTable logTable = new JTable(logModel);

  // Store full RR objects so selection can populate native editors
  private final List<HttpRequestResponse> rrLog = new CopyOnWriteArrayList<>();

  private volatile boolean running = false;
  private volatile Imported imported = null;

  private final ExecutorService worker = Executors.newSingleThreadExecutor(r -> {
    Thread t = new Thread(r, "ai-pentester-worker");
    t.setDaemon(true);
    return t;
  });

  private final AgentEngine engine;

  public AgentTab(MontoyaApi api) {
    this.api = api;

    // Build persona combo: General + built-ins + Custom.
    java.util.List<String> personaItems = new java.util.ArrayList<>();
    personaItems.add(PERSONA_DEFAULT);
    personaItems.addAll(AgentEngine.BUILT_IN_PERSONAS.keySet());
    personaItems.add(PERSONA_CUSTOM);
    this.personaCombo = new JComboBox<>(personaItems.toArray(new String[0]));

    // Create native editors via Montoya UI.
    this.requestEditor = api.userInterface().createHttpRequestEditor();
    this.responseEditor = api.userInterface().createHttpResponseEditor();

    this.engine = new AgentEngine(api, this::appendActivity, this::appendLogRow, this::setEditors);

    buildUi();
    wireUi();
  }

  public JComponent ui() { return root; }

  // ---------------- Context Menu ----------------

  @Override
  public List<Component> provideMenuItems(ContextMenuEvent event) {
    // Selected request/response pairs are available here. 
    List<HttpRequestResponse> selected = event.selectedRequestResponses(); 
    Optional<MessageEditorHttpRequestResponse> editorSel = event.messageEditorRequestResponse(); 

    HttpRequestResponse rr = null;
    if (editorSel.isPresent()) {
      rr = editorSel.get().requestResponse(); // editor selection wrapper returns HttpRequestResponse 
    } else if (!selected.isEmpty()) {
      rr = selected.get(0); // first selected row 
    }
    if (rr == null) return emptyList();

    JMenuItem item = new JMenuItem("Send to AI Pentester...");
    HttpRequestResponse finalRr = rr;
    item.addActionListener(e -> importRequest(finalRr.request()));
    return List.of(item);
  }

  private void importRequest(HttpRequest req) {
    try {
      imported = Imported.from(req);
      targetBase.setText(imported.baseUrl);

      // Show raw imported request in native editor. 
      requestEditor.setRequest(req); 

      // Clear response editor
      if (imported.lastResponse != null) {
        responseEditor.setResponse(imported.lastResponse); 
      } else {
        responseEditor.setResponse(null);
      }

      if (prompt.getText().trim().isEmpty()) {
        prompt.setText("Test the imported request for a specific vulnerability (SQLi/XSS/IDOR). Validate with a PoC.");
      }

      appendActivity("\n" + "=".repeat(80) + "\n");
      appendActivity("IMPORTED REQUEST READY\n");
      appendActivity("URL: " + imported.fullUrl + "\n");
      appendActivity("Method: " + imported.method + "\n");
      appendActivity("=".repeat(80) + "\n\n");

    } catch (Exception ex) {
      api.logging().logToError("Import failed: " + ex);
      appendActivity("[ERROR] Import failed: " + ex.getMessage() + "\n");
    }
  }

  // ---------------- UI ----------------

  private void buildUi() {
    root.setBorder(new EmptyBorder(5, 5, 5, 5));

    activity.setEditable(false);
    activity.setLineWrap(true);
    activity.setWrapStyleWord(true);
    activity.setFont(new Font("Monospaced", Font.PLAIN, 12));
    activity.setBackground(new Color(245, 245, 245));

    prompt.setFont(new Font("SansSerif", Font.PLAIN, 13));
    prompt.setLineWrap(true);
    prompt.setWrapStyleWord(true);

    JPanel top = new JPanel(new GridBagLayout());
    GridBagConstraints gbc = new GridBagConstraints();
    gbc.insets = new Insets(4, 4, 4, 4);
    gbc.fill = GridBagConstraints.HORIZONTAL;

    // --- Settings Panel ---
    JPanel settingsPanel = new JPanel(new GridBagLayout());
    settingsPanel.setBorder(BorderFactory.createTitledBorder("Agent Configuration"));
    GridBagConstraints sGbc = new GridBagConstraints();
    sGbc.insets = new Insets(2, 5, 2, 5);
    sGbc.anchor = GridBagConstraints.WEST;

    // Row 0: Provider + Model
    sGbc.gridx = 0; sGbc.gridy = 0; sGbc.weightx = 0;
    settingsPanel.add(new JLabel("Provider:"), sGbc);
    sGbc.gridx = 1; sGbc.weightx = 0.5; settingsPanel.add(providerCombo, sGbc);
    sGbc.gridx = 2; sGbc.weightx = 0;
    settingsPanel.add(new JLabel("Model:"), sGbc);
    sGbc.gridx = 3; sGbc.weightx = 1.0; settingsPanel.add(model, sGbc);

    // Row 1: Provider-specific field (Ollama URL or Gemini API Key) via CardLayout panel
    CardLayout providerCardLayout = new CardLayout();
    JPanel providerCard = new JPanel(providerCardLayout);

    JPanel ollamaPanel = new JPanel(new BorderLayout(5, 0));
    ollamaUrlLabel = new JLabel("Ollama URL:");
    ollamaPanel.add(ollamaUrlLabel, BorderLayout.WEST);
    ollamaPanel.add(ollamaUrl, BorderLayout.CENTER);
    providerCard.add(ollamaPanel, "Ollama");

    JPanel geminiPanel = new JPanel(new BorderLayout(5, 0));
    geminiKeyLabel = new JLabel("API Key:");
    geminiPanel.add(geminiKeyLabel, BorderLayout.WEST);
    geminiPanel.add(geminiApiKey, BorderLayout.CENTER);
    providerCard.add(geminiPanel, "Gemini");

    sGbc.gridx = 0; sGbc.gridy = 1; sGbc.weightx = 1.0; sGbc.gridwidth = 2; sGbc.fill = GridBagConstraints.HORIZONTAL;
    settingsPanel.add(providerCard, sGbc);

    // Row 1 (right): Target Base
    sGbc.gridx = 2; sGbc.gridy = 1; sGbc.weightx = 0; sGbc.gridwidth = 1; sGbc.fill = GridBagConstraints.NONE;
    settingsPanel.add(new JLabel("Target Base:"), sGbc);
    sGbc.gridx = 3; sGbc.weightx = 1.0; sGbc.fill = GridBagConstraints.HORIZONTAL;
    settingsPanel.add(targetBase, sGbc);

    // Wire provider combo → switch card
    providerCombo.addActionListener(e -> {
      String sel = (String) providerCombo.getSelectedItem();
      providerCardLayout.show(providerCard, sel == null ? "Ollama" : sel);
      if ("Gemini".equals(sel) && model.getText().trim().isEmpty()) {
        model.setText("gemini-2.0-flash");
      }
    });

    // Row 2: left — max iterations + auto-mode; right — persona (directly under Model / Target Base)
    JPanel miscRow = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
    miscRow.add(new JLabel("Max Iterations: "));
    miscRow.add(maxIter);
    miscRow.add(Box.createHorizontalStrut(20));
    miscRow.add(autoMode);

    sGbc.gridx = 0; sGbc.gridy = 2; sGbc.gridwidth = 2; sGbc.weightx = 0.5; sGbc.fill = GridBagConstraints.NONE;
    settingsPanel.add(miscRow, sGbc);

    // Row 2 right: Persona — aligned under Model / Target Base
    personaFilePath.setEditable(false);
    personaFilePath.setToolTipText("Path to custom system prompt .md file");
    personaFilePath.setVisible(false);
    personaBrowseBtn.setVisible(false);

    JPanel personaRow = new JPanel(new FlowLayout(FlowLayout.LEFT, 5, 0));
    personaRow.add(new JLabel("Persona:"));
    personaRow.add(personaCombo);
    personaRow.add(personaFilePath);
    personaRow.add(personaBrowseBtn);

    sGbc.gridx = 2; sGbc.gridy = 2; sGbc.gridwidth = 2; sGbc.weightx = 1.0; sGbc.fill = GridBagConstraints.HORIZONTAL;
    settingsPanel.add(personaRow, sGbc);

    gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 1.0;
    top.add(settingsPanel, gbc);

    // --- Buttons ToolBar ---
    JPanel toolBar = new JPanel(new FlowLayout(FlowLayout.LEFT));
    start.setBackground(new Color(230, 255, 230));
    stop.setForeground(Color.RED);
    toolBar.add(testConn);
    toolBar.add(new JSeparator(JSeparator.VERTICAL));
    toolBar.add(start);
    toolBar.add(stop);
    toolBar.add(new JSeparator(JSeparator.VERTICAL));
    toolBar.add(send);
    toolBar.add(clear);
    toolBar.add(report);

    gbc.gridy = 1;
    top.add(toolBar, gbc);

    // --- Prompt Panel ---
    JPanel promptPanel = new JPanel(new BorderLayout());
    promptPanel.setBorder(BorderFactory.createTitledBorder("Message to Agent"));
    prompt.setText("Perform a comprehensive penetration test. Start with reconnaissance, then test OWASP Top 10.");
    promptPanel.add(new JScrollPane(prompt), BorderLayout.CENTER);
    promptPanel.setPreferredSize(new Dimension(0, 100));

    gbc.gridy = 2;
    top.add(promptPanel, gbc);

    root.add(top, BorderLayout.NORTH);

    // Main split: activity/log + editors
    JSplitPane mainSplit = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);
    mainSplit.setResizeWeight(0.5);
    mainSplit.setDividerLocation(0.5);

    // Left side: Activity and Log
    JSplitPane activityLogSplit = new JSplitPane(JSplitPane.VERTICAL_SPLIT);
    activityLogSplit.setResizeWeight(0.6);

    JPanel activityPanel = new JPanel(new BorderLayout());
    activityPanel.setBorder(BorderFactory.createTitledBorder("Agent Activity"));
    activityPanel.add(new JScrollPane(activity), BorderLayout.CENTER);
    activityLogSplit.setTopComponent(activityPanel);

    JPanel logPanel = new JPanel(new BorderLayout());
    logPanel.setBorder(BorderFactory.createTitledBorder("Request Log"));
    logPanel.add(new JScrollPane(logTable), BorderLayout.CENTER);
    activityLogSplit.setBottomComponent(logPanel);

    // Right side: Request/Response editors
    JSplitPane editorSplit = new JSplitPane(JSplitPane.VERTICAL_SPLIT);
    editorSplit.setResizeWeight(0.5);

    JPanel reqPanel = new JPanel(new BorderLayout());
    reqPanel.setBorder(BorderFactory.createTitledBorder("Request (Burp native editor)"));
    reqPanel.add(requestEditor.uiComponent(), BorderLayout.CENTER);

    JPanel respPanel = new JPanel(new BorderLayout());
    respPanel.setBorder(BorderFactory.createTitledBorder("Response (Burp native editor)"));
    respPanel.add(responseEditor.uiComponent(), BorderLayout.CENTER);

    editorSplit.setTopComponent(reqPanel);
    editorSplit.setBottomComponent(respPanel);

    mainSplit.setLeftComponent(activityLogSplit);
    mainSplit.setRightComponent(editorSplit);

    root.add(mainSplit, BorderLayout.CENTER);

    JPanel statusPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
    statusPanel.setBorder(new EmptyBorder(2, 2, 2, 2));
    statusPanel.add(new JLabel("Status: "));
    statusPanel.add(statusLabel);
    root.add(statusPanel, BorderLayout.SOUTH);

    stop.setEnabled(false);

    // Apply Burp theme.
    api.userInterface().applyThemeToComponent(root);

    logTable.getSelectionModel().addListSelectionListener(e -> {
      if (e.getValueIsAdjusting()) return;
      int row = logTable.getSelectedRow();
      if (row < 0 || row >= rrLog.size()) return;

      HttpRequestResponse rr = rrLog.get(row);
      if (rr == null) return;
      setEditors(rr);
    });
  }

  private void wireUi() {
    // --- Persona combo wiring ---
    personaCombo.addActionListener(e -> {
      boolean isCustom = PERSONA_CUSTOM.equals(personaCombo.getSelectedItem());
      personaFilePath.setVisible(isCustom);
      personaBrowseBtn.setVisible(isCustom);
      if (!isCustom) {
        customPersonaContent = null;
        personaFilePath.setText("");
      }
    });

    personaBrowseBtn.addActionListener(e -> {
      JFileChooser chooser = new JFileChooser();
      chooser.setDialogTitle("Select custom system prompt file");
      chooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter("Markdown / Text files", "md", "txt"));
      if (chooser.showOpenDialog(root) == JFileChooser.APPROVE_OPTION) {
        java.io.File file = chooser.getSelectedFile();
        try {
          customPersonaContent = new String(java.nio.file.Files.readAllBytes(file.toPath()), java.nio.charset.StandardCharsets.UTF_8);
          personaFilePath.setText(file.getAbsolutePath());
          appendActivity("[INFO] Custom persona loaded: " + file.getName() + " (" + customPersonaContent.length() + " chars)\n");
        } catch (Exception ex) {
          appendActivity("[ERROR] Failed to load custom persona: " + ex.getMessage() + "\n");
          customPersonaContent = null;
          personaFilePath.setText("");
        }
      }
    });

    testConn.addActionListener(e -> worker.submit(() -> {
      try {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Testing connection..."));
        engine.testConnection(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            geminiApiKey.getText().trim()
        );
      } catch (Throwable t) {
        api.logging().logToError("Test connection crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Test connection crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Ready"));
      }
    }));

    start.addActionListener(e -> worker.submit(() -> {
      if (running) return;
      try {
        running = true;
        SwingUtilities.invokeLater(() -> {
          start.setEnabled(false);
          stop.setEnabled(true);
          statusLabel.setText("Agent Running...");
        });

        engine.runAgent(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            geminiApiKey.getText().trim(),
            targetBase.getText().trim(),
            (int) maxIter.getValue(),
            autoMode.isSelected(),
            imported,
            prompt.getText(),
            resolvePersonaPayload()
        );

      } catch (Throwable t) {
        api.logging().logToError("Agent execution crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Agent crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        running = false;
        SwingUtilities.invokeLater(() -> {
          start.setEnabled(true);
          stop.setEnabled(false);
          statusLabel.setText("Agent Stopped / Ready");
        });
      }
    }));

    stop.addActionListener(e -> {
      engine.stop();
      statusLabel.setText("Stopping...");
    });

    send.addActionListener(e -> worker.submit(() -> {
      if (running) return;
      try {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Sending message..."));
        engine.singleTurn(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            geminiApiKey.getText().trim(),
            targetBase.getText().trim(),
            imported,
            prompt.getText(),
            resolvePersonaPayload()
        );
      } catch (Throwable t) {
        api.logging().logToError("Single turn crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Single turn crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Ready"));
      }
    }));

    clear.addActionListener(e -> SwingUtilities.invokeLater(() -> {
      activity.setText("");
      while (logModel.getRowCount() > 0) logModel.removeRow(0);
      rrLog.clear();
      imported = null;
      requestEditor.setRequest(HttpRequest.httpRequest()); // empty request 
      responseEditor.setResponse(null);
    }));

    report.addActionListener(e -> worker.submit(engine::generateReport));
  }

  // ---------------- callbacks used by AgentEngine ----------------

  private void appendActivity(String s) {
    SwingUtilities.invokeLater(() -> {
      activity.append(s);
      activity.setCaretPosition(activity.getDocument().getLength());
    });
  }

  private void appendLogRow(LogRow row, HttpRequestResponse rr) {
    rrLog.add(rr);
    SwingUtilities.invokeLater(() -> logModel.addRow(new Object[]{
        row.id, row.method, row.url, row.status, row.purpose, row.time
    }));
  }

  private void setEditors(HttpRequestResponse rr) {
    try {
      requestEditor.setRequest(rr.request()); // show request 
      if (rr.response() != null) {
        responseEditor.setResponse(rr.response()); // show response 
      } else {
        responseEditor.setResponse(null);
      }
    } catch (Exception ignored) {}
  }

  // ---------------- simple value objects ----------------

  /** Returns the currently selected provider name in lowercase (e.g. "ollama", "gemini"). */
  private String selectedProvider() {
    Object sel = providerCombo.getSelectedItem();
    return sel == null ? "ollama" : String.valueOf(sel).toLowerCase(java.util.Locale.ROOT);
  }

  /**
   * Resolves the active persona into a payload string for {@link AgentEngine#runAgent}.<ul>
   *   <li>"General (default)" → null (engine uses base prompt as-is)</li>
   *   <li>Named built-in → "persona:<Name>" (engine appends focus block)</li>
   *   <li>"Custom File..." + file loaded → full custom content (engine uses as full replacement)</li></ul>
   */
  private String resolvePersonaPayload() {
    String selected = (String) personaCombo.getSelectedItem();
    if (selected == null || PERSONA_DEFAULT.equals(selected)) return null;
    if (PERSONA_CUSTOM.equals(selected)) return customPersonaContent; // may be null if no file loaded
    return "persona:" + selected;
  }

  static class LogRow {
    final int id;
    final String method, url, purpose, time;
    final int status;

    LogRow(int id, String method, String url, int status, String purpose) {
      this.id = id;
      this.method = method;
      this.url = url;
      this.status = status;
      this.purpose = purpose;
      this.time = LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss"));
    }
  }
}

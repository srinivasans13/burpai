package com.burpai.aipentester.ui;

import burp.api.montoya.MontoyaApi;
import burp.api.montoya.http.message.HttpRequestResponse;
import burp.api.montoya.http.message.requests.HttpRequest;
import burp.api.montoya.ui.contextmenu.ContextMenuEvent;
import burp.api.montoya.ui.contextmenu.ContextMenuItemsProvider;
import burp.api.montoya.ui.contextmenu.MessageEditorHttpRequestResponse;
import burp.api.montoya.ui.editor.HttpRequestEditor;
import burp.api.montoya.ui.editor.HttpResponseEditor;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static java.util.Collections.emptyList;
import com.burpai.aipentester.agent.AgentEngine;
import com.burpai.aipentester.tools.Imported;

public class AgentTab implements ContextMenuItemsProvider {

  private final MontoyaApi api;
  private final JPanel root = new JPanel(new BorderLayout());

  // Controls
  private final JComboBox<String> providerCombo = new JComboBox<>(new String[]{"Ollama", "Gemini", "OpenRouter", "DeepSeek", "Claude", "OpenAI"});
  private final JTextField ollamaUrl = new JTextField("http://localhost:11434", 26);
  private final JTextField geminiApiKey = new JTextField("", 26);
  private final JTextField openRouterApiKey = new JTextField("", 26);
  private final JTextField deepSeekApiKey = new JTextField("", 26);
  private final JTextField claudeApiKey = new JTextField("", 26);
  private final JTextField openAiApiKey = new JTextField("", 26);
  private final JTextField model = new JTextField("glm-5:cloud", 26);
  private final JTextField targetBase = new JTextField("http://localhost", 34);
  private final JSpinner maxIter = new JSpinner(new SpinnerNumberModel(20, 1, 200, 1));
  private final JCheckBox autoMode = new JCheckBox("Auto Mode", true);

  // Label refs needed to show/hide in wireUi
  private JLabel ollamaUrlLabel;
  private JLabel geminiKeyLabel;
  private JLabel openRouterKeyLabel;
  private JLabel deepSeekKeyLabel;
  private JLabel claudeKeyLabel;
  private JLabel openAiKeyLabel;

  // Persona selection
  private static final String PERSONA_DEFAULT = "General (default)";
  private static final String PERSONA_CUSTOM  = "Custom File...";
  private final JComboBox<String> personaCombo;
  private final JTextField personaFilePath = new JTextField("", 30);
  private final JButton personaBrowseBtn = new JButton("Browse...");
  private volatile String customPersonaContent = null; // non-null when a file has been loaded

  private final JButton testConn = new JButton("Test Connection");
  private final JButton start = new JButton("Start Agent");
  private final JButton stop = new JButton("Stop Agent");
  private final JButton send = new JButton("Send Message");
  private final JButton clear = new JButton("Clear");
  private final JButton report = new JButton("Generate Report");
  private final JButton exportCsv = new JButton("Export CSV");

  private final JTextArea prompt = new JTextArea(3, 80);
  private final JTextArea activity = new JTextArea(10, 90);
  private final JLabel statusLabel = new JLabel("Ready");

  // Native Burp editors in our tab 
  private final HttpRequestEditor requestEditor;
  private final HttpResponseEditor responseEditor;

  // Request log
  private final DefaultTableModel logModel = new DefaultTableModel(
      new Object[]{"#", "Method", "URL", "Status", "Purpose", "Time"}, 0
  );
  private final JTable logTable = new JTable(logModel);

  // Store full RR objects so selection can populate native editors
  private final List<HttpRequestResponse> rrLog = new CopyOnWriteArrayList<>();

  private volatile boolean running = false;
  private volatile Imported imported = null;

  private final ExecutorService worker = Executors.newSingleThreadExecutor(r -> {
    Thread t = new Thread(r, "ai-pentester-worker");
    t.setDaemon(true);
    return t;
  });

  private final AgentEngine engine;

  public AgentTab(MontoyaApi api) {
    this.api = api;

    // Build persona combo: General + built-ins + Custom.
    java.util.List<String> personaItems = new java.util.ArrayList<>();
    personaItems.add(PERSONA_DEFAULT);
    personaItems.addAll(AgentEngine.BUILT_IN_PERSONAS.keySet());
    personaItems.add(PERSONA_CUSTOM);
    this.personaCombo = new JComboBox<>(personaItems.toArray(new String[0]));

    // Create native editors via Montoya UI.
    this.requestEditor = api.userInterface().createHttpRequestEditor();
    this.responseEditor = api.userInterface().createHttpResponseEditor();

    this.engine = new AgentEngine(api, this::appendActivity, this::appendLogRow, this::setEditors);

    buildUi();
    wireUi();
  }

  public JComponent ui() { return root; }

  // ---------------- Context Menu ----------------

  @Override
  public List<Component> provideMenuItems(ContextMenuEvent event) {
    // Selected request/response pairs are available here. 
    List<HttpRequestResponse> selected = event.selectedRequestResponses(); 
    Optional<MessageEditorHttpRequestResponse> editorSel = event.messageEditorRequestResponse(); 

    HttpRequestResponse rr = null;
    if (editorSel.isPresent()) {
      rr = editorSel.get().requestResponse(); // editor selection wrapper returns HttpRequestResponse 
    } else if (!selected.isEmpty()) {
      rr = selected.get(0); // first selected row 
    }
    if (rr == null) return emptyList();

    JMenuItem item = new JMenuItem("Send to AI Pentester...");
    HttpRequestResponse finalRr = rr;
    item.addActionListener(e -> importRequest(finalRr.request()));
    return List.of(item);
  }

  private void importRequest(HttpRequest req) {
    try {
      imported = Imported.from(req);
      targetBase.setText(imported.baseUrl);

      // Show raw imported request in native editor. 
      requestEditor.setRequest(req); 

      // Clear response editor
      if (imported.lastResponse != null) {
        responseEditor.setResponse(imported.lastResponse); 
      } else {
        responseEditor.setResponse(null);
      }

      if (prompt.getText().trim().isEmpty()) {
        prompt.setText("Test the imported request for a specific vulnerability (SQLi/XSS/IDOR). Validate with a PoC.");
      }

      appendActivity("\n" + "=".repeat(80) + "\n");
      appendActivity("IMPORTED REQUEST READY\n");
      appendActivity("URL: " + imported.fullUrl + "\n");
      appendActivity("Method: " + imported.method + "\n");
      appendActivity("=".repeat(80) + "\n\n");

    } catch (Exception ex) {
      api.logging().logToError("Import failed: " + ex);
      appendActivity("[ERROR] Import failed: " + ex.getMessage() + "\n");
    }
  }

  // ---------------- UI ----------------

  // ── Light-theme colour palette (shared across build helpers) ──────────────
  private static final Color UI_BG          = new Color(248, 250, 252);
  private static final Color UI_SURFACE     = new Color(255, 255, 255);
  private static final Color UI_SURFACE2    = new Color(241, 245, 249);
  private static final Color UI_BORDER      = new Color(226, 232, 240);
  private static final Color UI_ACCENT      = new Color(2,  132, 199);
  private static final Color UI_ACCENT_LIGHT= new Color(224, 242, 254);
  private static final Color UI_DANGER      = new Color(220,  38,  38);
  private static final Color UI_DANGER_LIGHT= new Color(254, 226, 226);
  private static final Color UI_SUCCESS     = new Color(  5, 150, 105);
  private static final Color UI_SUCCESS_LIGHT=new Color(209, 250, 229);
  private static final Color UI_WARN        = new Color(217, 119,   6);
  private static final Color UI_WARN_LIGHT  = new Color(254, 243, 199);
  private static final Color UI_TEXT        = new Color( 15,  23,  42);
  private static final Color UI_TEXT2       = new Color(100, 116, 139);
  private static final Color UI_TEXT3       = new Color(148, 163, 184);

  /** Small uppercase muted label. */
  private static JLabel hdrLabel(String text) {
    JLabel l = new JLabel(text.toUpperCase());
    l.setFont(new Font("SansSerif", Font.BOLD, 10));
    l.setForeground(UI_TEXT2);
    return l;
  }

  /** Style an input field for the header bar. */
  private static void styleField(JTextField f, int prefW) {
    f.setFont(new Font("Monospaced", Font.PLAIN, 11));
    f.setForeground(UI_TEXT);
    f.setBackground(UI_BG);
    f.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createLineBorder(UI_BORDER),
        BorderFactory.createEmptyBorder(4, 7, 4, 7)));
    f.setPreferredSize(new Dimension(prefW, 26));
    f.setMaximumSize(new Dimension(prefW, 26));
  }

  /** Style a combo-box for the header bar. */
  private static void styleCombo(JComboBox<?> c) {
    c.setFont(new Font("Monospaced", Font.PLAIN, 11));
    c.setBackground(UI_BG);
    c.setForeground(UI_TEXT);
    c.setMaximumSize(new Dimension(220, 26));
  }

  /** Style a toolbar / action button. */
  private static void styleBtn(JButton b, Color bg, Color border, Color fg) {
    b.setFont(new Font("SansSerif", Font.PLAIN, 11));
    b.setBackground(bg);
    b.setForeground(fg);
    b.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createLineBorder(border),
        BorderFactory.createEmptyBorder(4, 12, 4, 12)));
    b.setFocusPainted(false);
    b.setOpaque(true);
    b.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
  }

  /** Thin vertical separator for toolbars. */
  private static JSeparator vSep() {
    JSeparator s = new JSeparator(JSeparator.VERTICAL);
    s.setMaximumSize(new Dimension(1, 20));
    s.setForeground(UI_BORDER);
    return s;
  }

  /** Section title label used inside panels. */
  private static JLabel sectionTitle(String text) {
    JLabel l = new JLabel(text.toUpperCase());
    l.setFont(new Font("SansSerif", Font.BOLD, 10));
    l.setForeground(UI_TEXT2);
    return l;
  }

  private void buildUi() {
    root.setBackground(UI_BG);
    root.setBorder(BorderFactory.createEmptyBorder());

    Font mono = new Font("Monospaced", Font.PLAIN, 11);

    // ─────────────────────────────── HEADER ──────────────────────────────────
    JPanel header = new JPanel();
    header.setLayout(new BoxLayout(header, BoxLayout.X_AXIS));
    header.setBackground(UI_SURFACE);
    header.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createMatteBorder(0, 0, 1, 0, UI_BORDER),
        BorderFactory.createEmptyBorder(7, 14, 7, 14)));

    JLabel logo = new JLabel("◈ BURP·AI");
    logo.setFont(new Font("SansSerif", Font.BOLD, 13));
    logo.setForeground(UI_ACCENT);
    logo.setBorder(BorderFactory.createEmptyBorder(0, 0, 0, 18));
    header.add(logo);

    // Provider
    header.add(hdrLabel("Provider"));
    header.add(Box.createHorizontalStrut(5));
    styleCombo(providerCombo);
    header.add(providerCombo);
    header.add(Box.createHorizontalStrut(10));

    // Model
    header.add(hdrLabel("Model"));
    header.add(Box.createHorizontalStrut(5));
    styleField(model, 200);
    header.add(model);
    header.add(Box.createHorizontalStrut(10));

    // Provider-specific API key / URL — CardLayout
    CardLayout providerCardLayout = new CardLayout();
    JPanel providerCard = new JPanel(providerCardLayout);
    providerCard.setOpaque(false);
    providerCard.setMaximumSize(new Dimension(310, 30));

    JPanel ollamaCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    ollamaCard.setOpaque(false);
    ollamaUrlLabel = new JLabel("Ollama URL:");
    ollamaUrlLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    ollamaUrlLabel.setForeground(UI_TEXT2);
    styleField(ollamaUrl, 200);
    ollamaCard.add(ollamaUrlLabel); ollamaCard.add(ollamaUrl);
    providerCard.add(ollamaCard, "Ollama");

    JPanel geminiCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    geminiCard.setOpaque(false);
    geminiKeyLabel = new JLabel("API Key:");
    geminiKeyLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    geminiKeyLabel.setForeground(UI_TEXT2);
    styleField(geminiApiKey, 200);
    geminiCard.add(geminiKeyLabel); geminiCard.add(geminiApiKey);
    providerCard.add(geminiCard, "Gemini");

    JPanel orCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    orCard.setOpaque(false);
    openRouterKeyLabel = new JLabel("API Key:");
    openRouterKeyLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    openRouterKeyLabel.setForeground(UI_TEXT2);
    styleField(openRouterApiKey, 200);
    orCard.add(openRouterKeyLabel); orCard.add(openRouterApiKey);
    providerCard.add(orCard, "OpenRouter");

    JPanel dsCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    dsCard.setOpaque(false);
    deepSeekKeyLabel = new JLabel("API Key:");
    deepSeekKeyLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    deepSeekKeyLabel.setForeground(UI_TEXT2);
    styleField(deepSeekApiKey, 200);
    dsCard.add(deepSeekKeyLabel); dsCard.add(deepSeekApiKey);
    providerCard.add(dsCard, "DeepSeek");

    JPanel claudeCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    claudeCard.setOpaque(false);
    claudeKeyLabel = new JLabel("API Key:");
    claudeKeyLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    claudeKeyLabel.setForeground(UI_TEXT2);
    styleField(claudeApiKey, 200);
    claudeCard.add(claudeKeyLabel); claudeCard.add(claudeApiKey);
    providerCard.add(claudeCard, "Claude");

    JPanel openAiCard = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0));
    openAiCard.setOpaque(false);
    openAiKeyLabel = new JLabel("API Key:");
    openAiKeyLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    openAiKeyLabel.setForeground(UI_TEXT2);
    styleField(openAiApiKey, 200);
    openAiCard.add(openAiKeyLabel); openAiCard.add(openAiApiKey);
    providerCard.add(openAiCard, "OpenAI");

    // Wire provider combo → switch card
    providerCombo.addActionListener(e -> {
      String sel = (String) providerCombo.getSelectedItem();
      providerCardLayout.show(providerCard, sel == null ? "Ollama" : sel);
      if ("Gemini".equals(sel)      && model.getText().trim().isEmpty()) model.setText("gemini-2.0-flash");
      else if ("OpenRouter".equals(sel) && model.getText().trim().isEmpty()) model.setText("deepseek/deepseek-r1-0528:free");
      else if ("DeepSeek".equals(sel)   && model.getText().trim().isEmpty()) model.setText("deepseek-reasoner");
      else if ("Claude".equals(sel)     && model.getText().trim().isEmpty()) model.setText("claude-opus-4-5");
      else if ("OpenAI".equals(sel)     && model.getText().trim().isEmpty()) model.setText("gpt-4o");
    });

    header.add(providerCard);
    header.add(Box.createHorizontalStrut(10));

    // Target
    header.add(hdrLabel("Target"));
    header.add(Box.createHorizontalStrut(5));
    styleField(targetBase, 220);
    header.add(targetBase);
    header.add(Box.createHorizontalStrut(10));

    // Persona
    header.add(hdrLabel("Persona"));
    header.add(Box.createHorizontalStrut(5));
    styleCombo(personaCombo);
    personaCombo.setMaximumSize(new Dimension(180, 26));
    header.add(personaCombo);
    header.add(Box.createHorizontalStrut(4));
    personaFilePath.setEditable(false);
    personaFilePath.setVisible(false);
    personaBrowseBtn.setVisible(false);
    styleField(personaFilePath, 180);
    personaFilePath.setMaximumSize(new Dimension(180, 26));
    header.add(personaFilePath);
    header.add(personaBrowseBtn);

    header.add(Box.createHorizontalGlue());

    // Auto-mode checkbox styled as a badge
    autoMode.setFont(new Font("SansSerif", Font.BOLD, 10));
    autoMode.setForeground(UI_SUCCESS);
    autoMode.setBackground(UI_SUCCESS_LIGHT);
    autoMode.setOpaque(true);
    autoMode.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createLineBorder(new Color(110, 231, 183)),
        BorderFactory.createEmptyBorder(3, 8, 3, 8)));
    header.add(autoMode);
    header.add(Box.createHorizontalStrut(10));

    // Status badge
    statusLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    statusLabel.setForeground(UI_ACCENT);
    statusLabel.setBackground(UI_ACCENT_LIGHT);
    statusLabel.setOpaque(true);
    statusLabel.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createLineBorder(new Color(147, 197, 253)),
        BorderFactory.createEmptyBorder(3, 10, 3, 10)));
    header.add(statusLabel);

    // ─────────────────────────────── TOOLBAR ─────────────────────────────────
    JPanel toolbar = new JPanel();
    toolbar.setLayout(new BoxLayout(toolbar, BoxLayout.X_AXIS));
    toolbar.setBackground(UI_SURFACE);
    toolbar.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createMatteBorder(0, 0, 1, 0, UI_BORDER),
        BorderFactory.createEmptyBorder(6, 14, 6, 14)));

    styleBtn(testConn, UI_SURFACE2, UI_BORDER, UI_TEXT2);
    toolbar.add(testConn);
    toolbar.add(Box.createHorizontalStrut(6));

    styleBtn(start, UI_ACCENT_LIGHT, new Color(147, 197, 253), UI_ACCENT);
    toolbar.add(start);
    toolbar.add(Box.createHorizontalStrut(4));

    styleBtn(stop, UI_DANGER_LIGHT, new Color(252, 165, 165), UI_DANGER);
    stop.setEnabled(false);
    toolbar.add(stop);
    toolbar.add(Box.createHorizontalStrut(8));
    toolbar.add(vSep());
    toolbar.add(Box.createHorizontalStrut(8));

    styleBtn(send, UI_SURFACE2, UI_BORDER, UI_TEXT2);
    toolbar.add(send);
    toolbar.add(Box.createHorizontalStrut(4));

    styleBtn(clear, UI_SURFACE2, UI_BORDER, UI_TEXT2);
    toolbar.add(clear);
    toolbar.add(Box.createHorizontalStrut(8));
    toolbar.add(vSep());
    toolbar.add(Box.createHorizontalStrut(8));

    styleBtn(report, UI_SUCCESS_LIGHT, new Color(110, 231, 183), UI_SUCCESS);
    toolbar.add(report);
    toolbar.add(Box.createHorizontalStrut(14));
    toolbar.add(vSep());
    toolbar.add(Box.createHorizontalStrut(10));

    JLabel maxIterLabel = new JLabel("Max Iters:");
    maxIterLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    maxIterLabel.setForeground(UI_TEXT2);
    toolbar.add(maxIterLabel);
    toolbar.add(Box.createHorizontalStrut(5));
    maxIter.setFont(mono);
    maxIter.setMaximumSize(new Dimension(64, 26));
    toolbar.add(maxIter);
    toolbar.add(Box.createHorizontalGlue());

    JPanel topWrapper = new JPanel(new BorderLayout());
    topWrapper.add(header,  BorderLayout.NORTH);
    topWrapper.add(toolbar, BorderLayout.SOUTH);
    root.add(topWrapper, BorderLayout.NORTH);

    // ──────────────────────────── MAIN WORKSPACE ─────────────────────────────

    // Activity text area
    activity.setEditable(false);
    activity.setLineWrap(true);
    activity.setWrapStyleWord(true);
    activity.setFont(mono);
    activity.setBackground(UI_BG);
    activity.setForeground(UI_TEXT);
    activity.setBorder(BorderFactory.createEmptyBorder(6, 10, 6, 10));

    JScrollPane activityScroll = new JScrollPane(activity);
    activityScroll.setBorder(BorderFactory.createEmptyBorder());
    activityScroll.getVerticalScrollBar().setUnitIncrement(16);

    JPanel activityHeader = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 5));
    activityHeader.setBackground(UI_SURFACE);
    activityHeader.setBorder(BorderFactory.createMatteBorder(0, 0, 1, 0, UI_BORDER));
    activityHeader.add(sectionTitle("Agent Activity"));

    JPanel activityPanel = new JPanel(new BorderLayout());
    activityPanel.setBackground(UI_SURFACE);
    activityPanel.add(activityHeader,  BorderLayout.NORTH);
    activityPanel.add(activityScroll,  BorderLayout.CENTER);

    // Prompt / message input
    prompt.setFont(new Font("SansSerif", Font.PLAIN, 12));
    prompt.setLineWrap(true);
    prompt.setWrapStyleWord(true);
    prompt.setBackground(UI_BG);
    prompt.setForeground(UI_TEXT);
    prompt.setBorder(BorderFactory.createEmptyBorder(6, 8, 6, 8));
    prompt.setText("Perform a comprehensive penetration test. Start with reconnaissance, then test OWASP Top 10.");

    JScrollPane promptScroll = new JScrollPane(prompt);
    promptScroll.setBorder(BorderFactory.createLineBorder(UI_BORDER));
    promptScroll.setPreferredSize(new Dimension(0, 70));

    JLabel msgLabel = new JLabel("Message to Agent");
    msgLabel.setFont(new Font("SansSerif", Font.BOLD, 10));
    msgLabel.setForeground(UI_TEXT2);
    msgLabel.setBorder(BorderFactory.createEmptyBorder(0, 0, 4, 0));

    JPanel msgWrap = new JPanel(new BorderLayout());
    msgWrap.setOpaque(false);
    msgWrap.add(msgLabel,    BorderLayout.NORTH);
    msgWrap.add(promptScroll, BorderLayout.CENTER);

    JPanel msgPanel = new JPanel(new BorderLayout(0, 0));
    msgPanel.setBackground(UI_SURFACE);
    msgPanel.setBorder(BorderFactory.createCompoundBorder(
        BorderFactory.createMatteBorder(0, 0, 1, 0, UI_BORDER),
        BorderFactory.createEmptyBorder(10, 14, 10, 14)));
    msgPanel.add(msgWrap, BorderLayout.CENTER);

    // Left top: message + activity log
    JPanel leftTop = new JPanel(new BorderLayout());
    leftTop.add(msgPanel,      BorderLayout.NORTH);
    leftTop.add(activityPanel, BorderLayout.CENTER);

    // Request log table
    logTable.setFont(mono);
    logTable.setBackground(UI_SURFACE);
    logTable.setForeground(UI_TEXT);
    logTable.setGridColor(UI_BORDER);
    logTable.setRowHeight(24);
    logTable.setShowHorizontalLines(true);
    logTable.setShowVerticalLines(false);
    logTable.setIntercellSpacing(new Dimension(0, 0));
    logTable.setSelectionBackground(UI_ACCENT_LIGHT);
    logTable.setSelectionForeground(UI_ACCENT);
    logTable.getTableHeader().setFont(new Font("SansSerif", Font.BOLD, 10));
    logTable.getTableHeader().setBackground(UI_SURFACE2);
    logTable.getTableHeader().setForeground(UI_TEXT2);
    logTable.getTableHeader().setBorder(BorderFactory.createMatteBorder(0, 0, 1, 0, UI_BORDER));

    JPanel logHeaderPanel = new JPanel(new BorderLayout());
    logHeaderPanel.setBackground(UI_SURFACE);
    logHeaderPanel.setBorder(BorderFactory.createMatteBorder(1, 0, 1, 0, UI_BORDER));
    JPanel logTitleLeft = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 5));
    logTitleLeft.setOpaque(false);
    logTitleLeft.add(sectionTitle("Request Log"));
    logHeaderPanel.add(logTitleLeft, BorderLayout.WEST);
    styleBtn(exportCsv, UI_SURFACE2, UI_BORDER, UI_TEXT2);
    exportCsv.setFont(new Font("SansSerif", Font.PLAIN, 10));
    JPanel logTitleRight = new JPanel(new FlowLayout(FlowLayout.RIGHT, 8, 3));
    logTitleRight.setOpaque(false);
    logTitleRight.add(exportCsv);
    logHeaderPanel.add(logTitleRight, BorderLayout.EAST);

    JPanel logPanel = new JPanel(new BorderLayout());
    logPanel.setBackground(UI_SURFACE);
    logPanel.add(logHeaderPanel, BorderLayout.NORTH);
    logPanel.add(new JScrollPane(logTable) {{ setBorder(BorderFactory.createEmptyBorder()); }}, BorderLayout.CENTER);

    // Left vertical split: activity·log (top) and request-log table (bottom)
    JSplitPane leftSplit = new JSplitPane(JSplitPane.VERTICAL_SPLIT, leftTop, logPanel);
    leftSplit.setResizeWeight(0.65);
    leftSplit.setDividerSize(4);
    leftSplit.setBorder(null);

    // Right side: tabbed request / response editors
    JPanel reqPanel = new JPanel(new BorderLayout());
    reqPanel.setBackground(UI_SURFACE);
    reqPanel.setBorder(BorderFactory.createTitledBorder(
        BorderFactory.createLineBorder(UI_BORDER), "HTTP Request",
        javax.swing.border.TitledBorder.LEFT, javax.swing.border.TitledBorder.TOP,
        new Font("SansSerif", Font.BOLD, 10), UI_TEXT2));
    reqPanel.add(requestEditor.uiComponent(), BorderLayout.CENTER);

    JPanel respPanel = new JPanel(new BorderLayout());
    respPanel.setBackground(UI_SURFACE);
    respPanel.setBorder(BorderFactory.createTitledBorder(
        BorderFactory.createLineBorder(UI_BORDER), "HTTP Response",
        javax.swing.border.TitledBorder.LEFT, javax.swing.border.TitledBorder.TOP,
        new Font("SansSerif", Font.BOLD, 10), UI_TEXT2));
    respPanel.add(responseEditor.uiComponent(), BorderLayout.CENTER);

    JSplitPane editorSplit = new JSplitPane(JSplitPane.VERTICAL_SPLIT, reqPanel, respPanel);
    editorSplit.setResizeWeight(0.5);
    editorSplit.setDividerSize(4);
    editorSplit.setBorder(null);

    // Main horizontal split
    JSplitPane mainSplit = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, leftSplit, editorSplit);
    mainSplit.setResizeWeight(0.55);
    mainSplit.setDividerSize(4);
    mainSplit.setBorder(null);
    root.add(mainSplit, BorderLayout.CENTER);

    // Apply Burp's own theme on top (honours dark/light Burp setting)
    api.userInterface().applyThemeToComponent(root);

    logTable.getSelectionModel().addListSelectionListener(e -> {
      if (e.getValueIsAdjusting()) return;
      int row = logTable.getSelectedRow();
      if (row < 0 || row >= rrLog.size()) return;

      HttpRequestResponse rr = rrLog.get(row);
      if (rr == null) return;
      setEditors(rr);
    });
  }

  private void wireUi() {
    // --- Persona combo wiring ---
    personaCombo.addActionListener(e -> {
      boolean isCustom = PERSONA_CUSTOM.equals(personaCombo.getSelectedItem());
      personaFilePath.setVisible(isCustom);
      personaBrowseBtn.setVisible(isCustom);
      if (!isCustom) {
        customPersonaContent = null;
        personaFilePath.setText("");
      }
    });

    personaBrowseBtn.addActionListener(e -> {
      JFileChooser chooser = new JFileChooser();
      chooser.setDialogTitle("Select custom system prompt file");
      chooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter("Markdown / Text files", "md", "txt"));
      if (chooser.showOpenDialog(root) == JFileChooser.APPROVE_OPTION) {
        java.io.File file = chooser.getSelectedFile();
        try {
          customPersonaContent = new String(java.nio.file.Files.readAllBytes(file.toPath()), java.nio.charset.StandardCharsets.UTF_8);
          personaFilePath.setText(file.getAbsolutePath());
          appendActivity("[INFO] Custom persona loaded: " + file.getName() + " (" + customPersonaContent.length() + " chars)\n");
        } catch (Exception ex) {
          appendActivity("[ERROR] Failed to load custom persona: " + ex.getMessage() + "\n");
          customPersonaContent = null;
          personaFilePath.setText("");
        }
      }
    });

    testConn.addActionListener(e -> worker.submit(() -> {
      try {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Testing connection..."));
        engine.testConnection(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            selectedApiKey()
        );
      } catch (Throwable t) {
        api.logging().logToError("Test connection crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Test connection crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Ready"));
      }
    }));

    start.addActionListener(e -> worker.submit(() -> {
      if (running) return;
      try {
        running = true;
        SwingUtilities.invokeLater(() -> {
          start.setEnabled(false);
          stop.setEnabled(true);
          statusLabel.setText("Agent Running...");
        });

        engine.runAgent(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            selectedApiKey(),
            targetBase.getText().trim(),
            (int) maxIter.getValue(),
            autoMode.isSelected(),
            imported,
            prompt.getText(),
            resolvePersonaPayload()
        );

      } catch (Throwable t) {
        api.logging().logToError("Agent execution crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Agent crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        running = false;
        SwingUtilities.invokeLater(() -> {
          start.setEnabled(true);
          stop.setEnabled(false);
          statusLabel.setText("Agent Stopped / Ready");
        });
      }
    }));

    stop.addActionListener(e -> {
      engine.stop();
      statusLabel.setText("Stopping...");
    });

    send.addActionListener(e -> worker.submit(() -> {
      if (running) return;
      try {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Sending message..."));
        engine.singleTurn(
            selectedProvider(),
            ollamaUrl.getText().trim(),
            model.getText().trim(),
            selectedApiKey(),
            targetBase.getText().trim(),
            imported,
            prompt.getText(),
            resolvePersonaPayload()
        );
      } catch (Throwable t) {
        api.logging().logToError("Single turn crashed: " + t);
        String msg = t.getMessage();
        if (msg == null || msg.isBlank()) msg = String.valueOf(t);
        appendActivity("[ERROR] Single turn crashed: " + t.getClass().getName() + ": " + msg + "\n");
      } finally {
        SwingUtilities.invokeLater(() -> statusLabel.setText("Ready"));
      }
    }));

    clear.addActionListener(e -> SwingUtilities.invokeLater(() -> {
      activity.setText("");
      while (logModel.getRowCount() > 0) logModel.removeRow(0);
      rrLog.clear();
      imported = null;
      requestEditor.setRequest(HttpRequest.httpRequest()); // empty request 
      responseEditor.setResponse(null);
    }));

    report.addActionListener(e -> worker.submit(engine::generateReport));

    exportCsv.addActionListener(e -> {
      if (logModel.getRowCount() == 0) {
        appendActivity("[INFO] Request log is empty — nothing to export.\n");
        return;
      }
      JFileChooser chooser = new JFileChooser();
      chooser.setDialogTitle("Export Request Log as CSV");
      chooser.setSelectedFile(new java.io.File("burpai-request-log.csv"));
      chooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter("CSV files", "csv"));
      if (chooser.showSaveDialog(root) != JFileChooser.APPROVE_OPTION) return;
      java.io.File file = chooser.getSelectedFile();
      if (!file.getName().toLowerCase(java.util.Locale.ROOT).endsWith(".csv")) {
        file = new java.io.File(file.getAbsolutePath() + ".csv");
      }
      final java.io.File dest = file;
      worker.submit(() -> {
        try (java.io.PrintWriter pw = new java.io.PrintWriter(
            new java.io.OutputStreamWriter(new java.io.FileOutputStream(dest), java.nio.charset.StandardCharsets.UTF_8))) {
          // Header row
          int cols = logModel.getColumnCount();
          StringBuilder hdr = new StringBuilder();
          for (int c = 0; c < cols; c++) {
            if (c > 0) hdr.append(',');
            hdr.append('"').append(logModel.getColumnName(c).replace("\"", "\"\"")).append('"');
          }
          pw.println(hdr);
          // Data rows
          for (int r = 0; r < logModel.getRowCount(); r++) {
            StringBuilder row = new StringBuilder();
            for (int c = 0; c < cols; c++) {
              if (c > 0) row.append(',');
              Object val = logModel.getValueAt(r, c);
              String s = val == null ? "" : String.valueOf(val);
              row.append('"').append(s.replace("\"", "\"\"")).append('"');
            }
            pw.println(row);
          }
          appendActivity("[INFO] Request log exported to: " + dest.getAbsolutePath() + "\n");
        } catch (Exception ex) {
          appendActivity("[ERROR] CSV export failed: " + ex.getMessage() + "\n");
        }
      });
    });
  }

  // ---------------- callbacks used by AgentEngine ----------------

  private void appendActivity(String s) {
    SwingUtilities.invokeLater(() -> {
      activity.append(s);
      activity.setCaretPosition(activity.getDocument().getLength());
    });
  }

  private void appendLogRow(LogRow row, HttpRequestResponse rr) {
    rrLog.add(rr);
    SwingUtilities.invokeLater(() -> logModel.addRow(new Object[]{
        row.id, row.method, row.url, row.status, row.purpose, row.time
    }));
  }

  private void setEditors(HttpRequestResponse rr) {
    try {
      requestEditor.setRequest(rr.request()); // show request 
      if (rr.response() != null) {
        responseEditor.setResponse(rr.response()); // show response 
      } else {
        responseEditor.setResponse(null);
      }
    } catch (Exception ignored) {}
  }

  // ---------------- simple value objects ----------------

  /** Returns the currently selected provider name in lowercase (e.g. "ollama", "gemini", "openrouter", "deepseek"). */
  private String selectedProvider() {
    Object sel = providerCombo.getSelectedItem();
    return sel == null ? "ollama" : String.valueOf(sel).toLowerCase(java.util.Locale.ROOT);
  }

  /** Returns the API key for the currently selected API-key-based provider, or empty string for Ollama. */
  private String selectedApiKey() {
    String provider = selectedProvider();
    if ("gemini".equals(provider)) return geminiApiKey.getText().trim();
    if ("openrouter".equals(provider)) return openRouterApiKey.getText().trim();
    if ("deepseek".equals(provider)) return deepSeekApiKey.getText().trim();
    if ("claude".equals(provider)) return claudeApiKey.getText().trim();
    if ("openai".equals(provider)) return openAiApiKey.getText().trim();
    return ""; // Ollama uses URL, not an API key
  }

  /**
   * Resolves the active persona into a payload string for {@link AgentEngine#runAgent}.<ul>
   *   <li>"General (default)" → null (engine uses base prompt as-is)</li>
   *   <li>Named built-in → "persona:<Name>" (engine appends focus block)</li>
   *   <li>"Custom File..." + file loaded → full custom content (engine uses as full replacement)</li></ul>
   */
  private String resolvePersonaPayload() {
    String selected = (String) personaCombo.getSelectedItem();
    if (selected == null || PERSONA_DEFAULT.equals(selected)) return null;
    if (PERSONA_CUSTOM.equals(selected)) return customPersonaContent; // may be null if no file loaded
    return "persona:" + selected;
  }

  public static class LogRow {
    final int id;
    final String method, url, purpose, time;
    final int status;

    public LogRow(int id, String method, String url, int status, String purpose) {
      this.id = id;
      this.method = method;
      this.url = url;
      this.status = status;
      this.purpose = purpose;
      this.time = LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss"));
    }
  }
}

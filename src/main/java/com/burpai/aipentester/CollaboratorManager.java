package com.burpai.aipentester;

import burp.api.montoya.MontoyaApi;
import burp.api.montoya.collaborator.CollaboratorClient;
import burp.api.montoya.collaborator.CollaboratorPayload;
import burp.api.montoya.collaborator.Interaction;

import java.util.*;

/**
 * Manages a single Burp Collaborator OAST session per agent run.
 *
 * <p>Provides out-of-band (OOB) payload generation and interaction polling for
 * detecting blind vulnerabilities (SQLi, SSRF, XXE, XSS) that produce no
 * in-band signal in the HTTP response.
 *
 * <p>On Burp Community Edition the Collaborator API is unavailable; in that case
 * {@link #isAvailable()} returns {@code false} and all methods are no-ops or
 * return empty results so the agent degrades gracefully.
 */
class CollaboratorManager {

  private final MontoyaApi api;
  private final AgentLogger logger;

  /** Null when Collaborator is unavailable (Community edition or initialisation failure). */
  private volatile CollaboratorClient client;

  CollaboratorManager(MontoyaApi api, AgentLogger logger) {
    this.api = api;
    this.logger = logger;
  }

  // ── Lifecycle ─────────────────────────────────────────────────────────────

  /**
   * Allocates a fresh Collaborator client for this agent run.
   * Called once at the start of every run by {@link ToolExecutor#reset()}.
   */
  void reset() {
    client = null;
    try {
      client = api.collaborator().createClient();
      // Generate one throwaway payload to confirm the client is valid
      CollaboratorPayload probe = client.generatePayload();
      logger.log("[Collaborator] OAST session ready — server: " + probe.toString() + "\n");
    } catch (UnsupportedOperationException e) {
      logger.log("[Collaborator] Collaborator unavailable on this Burp edition — OOB detection disabled.\n");
      client = null;
    } catch (Exception e) {
      logger.log("[Collaborator] Could not initialise Collaborator client: " + e.getMessage() + "\n");
      client = null;
    }
  }

  // ── Public API ────────────────────────────────────────────────────────────

  /** {@code true} if a Collaborator client was successfully created for this run. */
  boolean isAvailable() {
    return client != null;
  }

  /**
   * Generates a unique OOB payload domain.
   *
   * <p>Example: {@code x1a2b3.oastify.com}
   *
   * @return the payload domain string, or {@code null} if Collaborator is unavailable
   */
  String generatePayload() {
    if (client == null) return null;
    try {
      return client.generatePayload().toString();
    } catch (Exception e) {
      logger.log("[Collaborator] generatePayload failed: " + e.getMessage() + "\n");
      return null;
    }
  }

  /**
   * Polls the Collaborator server for all interactions recorded since the last poll.
   *
   * @return list of interaction detail maps (type, timestamp, client_ip, protocol details),
   *         or an empty list if Collaborator is unavailable or no interactions exist
   */
  List<Map<String, Object>> pollInteractions() {
    if (client == null) return List.of();
    try {
      List<Interaction> interactions = client.getAllInteractions();
      if (interactions.isEmpty()) return List.of();

      List<Map<String, Object>> result = new ArrayList<>();
      for (Interaction i : interactions) {
        Map<String, Object> m = new LinkedHashMap<>();
        try { m.put("type",      i.type().name()); }       catch (Exception ignored) {}
        try { m.put("timestamp", i.timeStamp().toString()); } catch (Exception ignored) {}
        try { m.put("client_ip", i.clientIp());  }          catch (Exception ignored) {}

        // DNS-specific details
        try {
          i.dnsDetails().ifPresent(dns -> {
            try { m.put("dns_query_type", dns.queryType().name()); } catch (Exception ignored) {}
          });
        } catch (Exception ignored) {}

        // HTTP-specific details
        try {
          i.httpDetails().ifPresent(http -> {
            try { m.put("http_method",   http.requestResponse().request().method()); }    catch (Exception ignored) {}
            try { m.put("http_path",     http.requestResponse().request().path());  }     catch (Exception ignored) {}
            try { m.put("http_protocol", http.requestResponse().request().httpVersion()); } catch (Exception ignored) {}
          });
        } catch (Exception ignored) {}

        result.add(m);
      }
      return result;
    } catch (Exception e) {
      logger.log("[Collaborator] pollInteractions failed: " + e.getMessage() + "\n");
      return List.of();
    }
  }
}
